---
- name: "Show who is master ;)"
  ansible.builtin.debug:
    msg: "Cluster master will be: {{ cluster_master | default('Unknown') }}"

- name: "Remove all anonymous users"
  block:
    - name: "Try to remove all anonymous users..."
      community.mysql.mysql_user:
        name: ''
        host_all: true
        state: "absent"
  rescue:
    - name: "Well..."
      ansible.builtin.debug:
        msg: "May be all anonymous users already removed?"

- name: "Setup root password for cluster and limit it to localhost login only"
  block:
    - name: "Try to setup root password for cluster and limit it to localhost login only"
      community.mysql.mysql_user:
        name: "root"
        host: "{{ item }}"
        password: "{{ cluster_root_password }}"
        check_implicit_admin: true
        login_user: "root"
        login_password: "{{ cluster_init_root_password }}"
        state: "present"
      with_items:
        - "127.0.0.1"
        - "::1"
        - "localhost"
  rescue:
    - name: "Oops!!!"
      ansible.builtin.debug:
        msg: "Oops!!! It's seems that root password already set"

- name: "Calculate server-id"
  ansible.builtin.set_fact:
    server_id: "{{ ansible_hostname | regex_search ('[0-9]+') | int }}"

- name: "Show server-id"
  ansible.builtin.debug:
    msg: "'server-id' is: {{ server_id }}"

- name: "Copy server.conf to /etc/my.cnf.d"
  become: true
  ansible.builtin.template:
    src: "templates/server.cnf.j2"
    dest: "/etc/my.cnf.d/server.cnf"
    owner: "root"
    group: "root"
    mode: '0644'
  notify: "Restart MariaDB"

- name: "Flush handlers"
  ansible.builtin.meta:
    flush_handlers
