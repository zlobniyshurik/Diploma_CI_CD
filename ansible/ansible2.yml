---
- name: "Reconfigure DNF to use proxy"
  hosts: Pass2
  gather_facts: false
  become: true
  become_user: "root"
  remote_user: "cloud-user"
  roles:
    - role: setup_proxy_dnf
      vars:
        setup_proxy_fqdn: "{{ tf_proxy_name }}"
        setup_proxy_port: "{{ tf_proxy_port }}"

- name: "Install common tools"
  hosts: Pass2
  gather_facts: true
  become: true
  become_user: "root"
  remote_user: "cloud-user"
  roles:
    - role: install_common

- name: "Install Database-servers"
  hosts: Databases
  gather_facts: true
  become: true
  become_user: "root"
  remote_user: "cloud-user"
  roles:
    - role: install_mariadb
    - role: setup_cluster
      vars:
        cluster_master: "{{ db_master }}"
    - role: setup_db
      vars:                                # неохота мне еще и явки/пароли вордпресса в переменные выносить
        setup_db_host: "{{ db_master }}"   # пусть будут захардкожены открытым текстом
        setup_db_name: "wordpress"
        setup_db_owner_user: "wordpress"
        setup_db_owner_pass: "wordpress"

- name: "Install Wordpress-server"
  hosts: Applications
  gather_facts: false
  become: true
  become_user: "root"
  remote_user: "cloud-user"
  roles:
    - role: install_app
      vars:
        install_app_my_domain_tld: "{{ tf_my_domain_tld }}"
        install_app_db_host: "{{ tf_db_master_ip }}"
        install_app_db_name: "wordpress"
        install_app_db_user: "wordpress"
        install_app_db_pass: "wordpress"
  environment:
    http_proxy: "http://{{ tf_proxy_name }}:{{ tf_proxy_port }}"
    https_proxy: "http://{{ tf_proxy_name }}:{{ tf_proxy_port }}"

# - name: "Install Gitlab-server"
#  hosts: Applications
#  gather_facts: false
#  become: true
#  become_user: "root"
#  remote_user: "cloud-user"
#  roles:
#    - role: install_gitlab

# - name: "Install Gitlab-runner"
#  hosts: Applications
#  gather_facts: false
#  become: true
#  become_user: "root"
#  remote_user: "cloud-user"
#  roles:
#    - role: install_grunner
